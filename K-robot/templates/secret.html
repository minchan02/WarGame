<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Robot Fix Game</title>
  <style>
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      justify-content:center; align-items:center; background:#0d0d1a; color:#fff;
      font-family:system-ui, sans-serif;
    }
    h1{ margin-bottom:4px; }
    #score{ font-size:1.2rem; margin-bottom:12px; }
    #flag{
      margin-top:16px; padding:12px 24px; border-radius:8px;
      background:#ff0066; font-weight:700; display:none;
      word-break:break-all;
    }
    #robot{
      position:absolute; width:120px; height:auto; cursor:pointer;
      transition:transform .1s;
    }
    #robot:active{ transform:scale(0.9); }
  </style>
</head>
<body>
  <h1 id="desc">Click My Robot and Fix it!!</h1>
  <div id="score">Score : 10000</div>

  <div id="flag"></div>

  <img id="robot" src="{{ url_for('static', filename='robot.png') }}" alt="robot">

  <script>
  (()=>{
    const robot        = document.getElementById('robot');
    const scoreBox     = document.getElementById('score');
    const descBox      = document.getElementById('desc');
    const flagBox      = document.getElementById('flag');
    const flagRobotURL = "{{ url_for('static', filename='flag_robot.png') }}";

    let score = 10000;

    const toHex   = n => n.toString(16).padStart(2,'0');
    const fromHex = h => parseInt(h,16);

    function xorHexDecrypt(hex, key){
      let res = '';
      for(let i=0;i<hex.length;i+=2){
        const byte = fromHex(hex.substr(i,2)) ^ key;
        res += String.fromCharCode(byte);
      }
      return res;
    }

    const KEYS = [11,29,37,45,53,61,77,89,101,127];
    let cipher = null;
    let keyIdx = KEYS.length - 1;

    fetch('/get_flag')
    .then(r=>r.text())
    .then(t=>{ cipher=t.trim(); });

    function decryptLayer(){
      if(keyIdx < 0) return;
      cipher = xorHexDecrypt(cipher, KEYS[keyIdx]);
      keyIdx--;

      if(keyIdx < 0){
        flagBox.textContent = cipher;
        flagBox.style.display = 'block';
        descBox.textContent = "Nice! This is FLAG"
        robot.src = flagRobotURL;
      }
    }

    function randomPos(){
      const pad = 140;
      return {
        x: Math.random() * (window.innerWidth  - pad),
        y: Math.random() * (window.innerHeight - pad)
      };
    }
    function moveRobot(){
      const {x,y} = randomPos();
      robot.style.left = x + 'px';
      robot.style.top  = y + 'px';
    }
    moveRobot();
    setInterval(moveRobot, 900);
    window.addEventListener('resize', moveRobot);

    robot.addEventListener('click', ()=>{
      score -= 1;
      scoreBox.textContent = `Score : ${score}`;

      if(score >= 0 && score % 1000 === 0){
        decryptLayer();
      } else if(score < 0 && keyIdx >= 0){
        while(keyIdx >= 0) decryptLayer();
      }
    });
  })();
  </script>
</body>
</html>
